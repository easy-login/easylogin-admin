{% extends 'loginapp/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block css %}
<!-- Sweet Alert css -->
        <link href="{%static 'plugins/sweet-alert/sweetalert2.min.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}
<!-- Page title -->
{% block topbar %}
<!-- Page title -->
<ul class="nav navbar-nav list-inline navbar-left" style="flex-direction: unset">
    <li class="list-inline-item">
        <button class="button-menu-mobile open-left">
            <i class="mdi mdi-menu"></i>
        </button>
    </li>
    <li class="list-inline-item">
        <h4 class="page-title">Channel</h4>
    </li>
    <li class="list-inline-item">
        <div class="create-app-button">
            <a href="{% url 'app_detail' app.id %}" type="button"
               class="btn btn-success btn-rounded w-md waves-effect waves-light m-b-5"><i
                    class="mdi mdi-keyboard-backspace"></i> <span>Back</span>
            </a>
        </div>
    </li>
</ul>

<nav class="navbar-custom">
    <ul class="list-unstyled topbar-right-menu float-right mb-0">
        <li class="list-inline-item">
            <div class="channel-list-select">
                <div class="dropdown">
                    <button type="button" class="btn btn-primary btn-rounded dropdown-toggle waves-effect waves-light"
                            data-toggle="dropdown" aria-expanded="false">{{ channel.provider }}
                    </button>
                    <div class="dropdown-menu">
                        <!-- item-->
                        {% for option in channels %}
                        <a href="{% url 'channel_detail' app.id option.id %}" class="dropdown-item">{{ option.provider }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </li>
    </ul>
</nav>
{% endblock %}


{% block sidemenu %}
<li>
    <a href="{% url 'dashboard' %}" class="waves-effect"><i class="mdi mdi-web"></i><span> Your Apps </span>
    </a>
</li>

<li>
    <a href="{% url 'profile' %}" class="waves-effect"><i class="mdi mdi-account"></i><span> Your Profile </span>
    </a>
</li>

{% endblock %}


{% block content%}
<div class="row">
    <div class="col-md-12">
        {% if messages %}
        {% for message in messages %}
        {% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
        <div class="alert alert-success alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
            <strong> {{ message }} </strong>
        </div>
        {% endif %}
        {% endfor %}

        {% for message in messages %}
        {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
        <div class="alert alert-danger alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
            <strong> {{ message }} </strong>
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
    </div>
    <div class="col-md-12">
        <div class="card-box">
                <form class="form-horizontal m-t-20" method="post" action="">
                    {% csrf_token %}
                        <div class="form-group row">
                            <div class="col-md-10">
                                {% render_field form.app_id class='form-control' value=app.id %}
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="id_provider" class="col-md-2 col-form-label">Provider</label>
                            <div class="col-md-8">
                                <select name="provider" id="id_provider" value="{{ channel.provider }}" class="form-control">
                                    {% for provider in providers %}
                                    <option value="{{ provider.id }}" {% if provider.id == channel.provider %} selected{% endif %}>{{ provider.id}}</option>
                                    {% endfor %}
                                </select>
                                {% if form.provider.errors %}
                                <ul class="parsley-errors-list filled">
                                    {% for error in form.provider.errors %}
                                    <li class="">{{ error }}</li>
                                    {% endfor%}
                                </ul>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="id_client_id" class="col-md-2 col-form-label">Client ID</label>
                            <div class="col-md-8">
                                {% render_field form.client_id class='form-control' placeholder='Client ID' value=channel.client_id %}
                                {% if form.client_id.errors %}
                                <ul class="parsley-errors-list filled">
                                    {% for error in form.client_id.errors %}
                                    <li class="">{{ error }}</li>
                                    {% endfor%}
                                </ul>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="id_client_secret" class="col-md-2 col-form-label">Client Secret</label>
                            <div class="col-md-8">
                                {% render_field form.client_secret class='form-control' placeholder='Client Secret' value=channel.client_secret %}
                                {% if form.client_secret.errors %}
                                <ul class="parsley-errors-list filled">
                                    {% for error in form.client_secret.errors %}
                                    <li class="">{{ error }}</li>
                                    {% endfor%}
                                </ul>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group row ">
                            <label for="id_permission" class="col-md-2 col-form-label">Permission</label>
                            <div class="col-md-8">
                                <div id="checkbox-error"></div>
                                {% with channel_permissions=channel.permission_as_list %}
                                {% for provider in providers %}
                                <div class="provider-permission checkbox-handler-error" id="id-{{ provider.id }}" style="display: none;">
                                    {% for permission in provider.permission_as_list %}
                                    <div class="checkbox checkbox-pink">
                                        <input id="{{ permission }}" name="permission" data-parsley-multiple="groups"
                                               data-parsley-mincheck="1"
                                               type="checkbox" value="{{ permission }}" required disabled
                                               data-parsley-errors-container="#checkbox-error"
                                               data-parsley-error-message="Permission value is required."
                                               data-parsley-class-handler=".checkbox-handler-error" {% if permission in channel_permissions %} checked{% endif %}>
                                        <label class="" for="{{ permission }}"> {{ permission }} </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                                {% endwith %}
                            </div>
                        </div>
                    <div class="form-group text-center m-t-40 row">
                        <div class="col-md-2"></div>
                        <div class="col-md-8">
                            <button class="btn btn-success btn-block waves-effect waves-light"
                                    type="submit">
                                Update
                            </button>
                        </div>
                    </div>
                </form>
                <form method="POST" action="{% url 'delete_channel' app.id channel.id %}">
                 {% csrf_token %}
                     <div class="form-group text-center m-t-40 row">
                        <div class="col-md-2"></div>
                        <div class="col-md-8">
                            <!--<input id="app_id" name="app_id" hidden type="text" value="{{ app.id }}">-->
                            <!--<input id="channel_id" name="channel_id" hidden type="text" value="{{ channel.id }}">-->
                            <button id="sa-warning" href="{% url 'delete_channel' app.id channel.id %}"
                               class="btn btn-danger btn-block waves-effect waves-light" onclick="deleteConfirm(event)"
                               type="submit">
                                Delete This Channel
                            </button>
                        </div>
                    </div>
                </form>
        </div>
    </div>
    <div class="clearfix"></div>
</div>
<!--/ meta -->
{% endblock %}

{% block js %}
<!-- Validation form-->
<script type="text/javascript" src="{% static 'plugins/parsleyjs/dist/parsley.min.js' %}"></script>
<!-- Sweet Alert Js  -->
<script src="{% static 'plugins/sweet-alert/sweetalert2.min.js' %} "></script>
<!--&lt;!&ndash; Modal-Effect &ndash;&gt;-->
<!--<script src="assets/plugins/custombox/dist/custombox.min.js"></script>-->
<!--<script src="assets/plugins/custombox/dist/legacy.min.js"></script>-->

<!--My js-->
<script type="text/javascript">
$(document).ready(function() {
    $('#id-'+ $('#id_provider').val()).show();
    $('#id-'+ $('#id_provider').val()+' input').prop('disabled', false);
    $('#id_provider').change(function(){
        $('.provider-permission').hide();

        $('.provider-permission input').prop("checked", false)
        $('.provider-permission input').prop('disabled', true)

        $('#id-'+ $('#id_provider').val()).show();
        $('#id-'+ $('#id_provider').val()+' input').prop('disabled', false);
    })
    $('form').parsley({excluded: 'input[disabled]'});
});

function getApiKey(){
//$('#img-loading').show()
$.ajax({
    url: '{% url 'get_api_key' %}',
    data: {},
    type: 'get',
    cache: false,
    success: function(key){
        $('#id_api_key').val(key)
        //$('#img-loading').hide()
    },
    error: function(message){
        alert("get api-key failed!")
        //$('#img-loading').hide()
    }
})
}

function deleteConfirm(event){
    event.preventDefault();
    var form = event.target.form;
    swal({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4fa7f3',
                cancelButtonColor: '#d57171',
                confirmButtonText: 'Yes, delete it!'
            }).then(function () {
            form.submit();
                swal(
                    'Deleted!',
                    'Your file has been deleted.',
                    'success'
                );
            });

}
</script>
{% endblock %}